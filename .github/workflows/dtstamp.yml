name: Auto-update DTSTAMP on changed VEVENTs

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  update-dtstamp:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'

      - name: Install dependencies
        run: npm install ical.js glob

      - name: Determine which ICS files to process
        id: files
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            find . -type f -name '*.ics' > ics_files.txt
          else
            git diff --name-only HEAD^ HEAD | grep '\.ics$' > ics_files.txt || true
            if ! [ -s ics_files.txt ]; then
              echo "No diffable .ics files found, defaulting to all .ics files (first commit?)"
              find . -type f -name '*.ics' > ics_files.txt
            fi
          fi
          echo "Will update these files:"
          cat ics_files.txt || echo "No .ics files to update."

      - name: Update DTSTAMP in selected ICS files
        run: |
          node -e '
            const fs = require("fs");
            const ICAL = require("ical.js");
            const files = fs.readFileSync("ics_files.txt", "utf-8").split("\n").filter(f => f.trim());
            const dtstamp = new Date().toISOString().replace(/[-:]/g,"").replace(/\.\d+Z/,"Z").replace("T","T");
            files.forEach(file => {
              if (!fs.existsSync(file)) return;
              let data = fs.readFileSync(file, "utf8");
              let jcal;
              try { jcal = ICAL.parse(data); } catch (e) { return; }
              const vcal = new ICAL.Component(jcal);
              let changed = false;
              vcal.getAllSubcomponents("vevent").forEach(vevent => {
                vevent.removeAllProperties("dtstamp");
                vevent.addPropertyWithValue("dtstamp", dtstamp);
                changed = true;
              });
              if (changed) {
                fs.writeFileSync(file, vcal.toString(), "utf8");
                console.log(`üíæ Updated DTSTAMPs in ${file}`);
              }
            });
          '

      - name: Validate DTSTAMP in selected ICS files
        run: |
          node -e '
            const fs = require("fs");
            const files = fs.readFileSync("ics_files.txt", "utf-8").split("\n").filter(f => f.trim());
            let failed = false;
            files.forEach(file => {
              if (!fs.existsSync(file)) return;
              let data;
              try { data = fs.readFileSync(file, "utf8"); } catch (e) { return; }
              let jcal;
              try { jcal = require("ical.js").parse(data); } catch (e) { 
                console.error(`‚ùå Error parsing ${file}: ${e.message}`); 
                failed = true; return; 
              }
              const vcal = new (require("ical.js").Component)(jcal);
              vcal.getAllSubcomponents("vevent").forEach(vevent => {
                const dtstamp = vevent.getFirstPropertyValue("dtstamp");
                if (!dtstamp) {
                  console.error(`‚ùå ${file}: VEVENT missing DTSTAMP`);
                  failed = true;
                }
              });
            });
            if (failed) process.exit(1);
            else console.log("‚úÖ All processed VEVENTs have DTSTAMP");
          '

      - name: Create Pull Request with DTSTAMP fixes
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: auto-update DTSTAMP on affected VEVENTs"
          title: "Auto-update DTSTAMP on changed VEVENTs"
          body: "This PR updates DTSTAMP for changed VEVENTs to ensure freshness and RFC compliance."
          branch: auto/update-dtstamp-${{ github.run_id }}
          base: main
          add-paths: '*.ics'
