name: Add DTSTAMP to changed ICS files

on:
  push:
    paths:
      - '**/*.ics'
  pull_request:
    paths:
      - '**/*.ics'
  workflow_dispatch:

jobs:
  add-dtstamp:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'

      - name: Install dependencies
        run: npm install ical.js glob

      - name: Get changed ICS files (or all, on manual)
        id: get-files
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            find . -type f -name '*.ics' > changed_ics_files.txt
          else
            git diff --name-only HEAD^ HEAD | grep '\.ics$' > changed_ics_files.txt || true
          fi
          echo "Changed files:"
          cat changed_ics_files.txt || echo "No .ics files changed."

      - name: Add DTSTAMP to each changed VEVENT (Node)
        run: |
          node -e '
            const fs = require("fs");
            const glob = require("glob");
            const ICAL = require("ical.js");
            const dtstamp = new Date().toISOString().replace(/[-:]/g,"").replace(/\.\d+Z/,"Z").replace("T","T");
            const files = fs.readFileSync("changed_ics_files.txt", "utf-8").split("\n").filter(f => f.trim());
            files.forEach(file => {
              if (!fs.existsSync(file)) return;
              let data = fs.readFileSync(file, "utf8");
              let jcal;
              try {
                jcal = ICAL.parse(data);
              } catch (e) {
                console.error("❌ Error parsing", file, e.message);
                return;
              }
              const vcal = new ICAL.Component(jcal);
              let updated = false;
              vcal.getAllSubcomponents("vevent").forEach(vevent => {
                vevent.removeAllProperties("dtstamp");
                vevent.addPropertyWithValue("dtstamp", dtstamp);
                updated = true;
              });
              if (updated) {
                fs.writeFileSync(file, vcal.toString(), "utf8");
                console.log(`✅ Updated DTSTAMPs in ${file}`);
              }
            });
          '

      - name: Commit and push changes (if any)
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "chore: auto-update DTSTAMP on changed VEVENTs"
          file_pattern: '*.ics'
